---
- name: Install bundler
  shell: bash -lc "gem install bundler:2.3.15"
  args: 
    chdir: /var/www/raisetech-live8-sample-app

- name: Install Rails
  shell: bash -lc "gem install rails -v 6.1.3"
  args: 
    chdir: /var/www/raisetech-live8-sample-app

# mysqlをインストールする際にGPGキーが必要となる。
# これをrpm_keyモジュールを使用してインポートする。
- name: Import RPM-GPG-KEY-mysql-2022
  rpm_key: 
    key: "https://repo.mysql.com/RPM-GPG-KEY-mysql-2022"

- name: Install mysql
  yum:
    name: mysql
    state: latest

- name: Install mysql
  yum:
    name: https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
    state: latest

- name: Install mysql-community-devel
  yum:
    name: mysql-community-devel
    state: latest

- name: Install mysql-community-server
  yum:
    name: mysql-community-server
    state: latest

- name: bundle install
  shell: bash -lc "bundle install"
  args: 
    chdir: /var/www/raisetech-live8-sample-app

- name: Set up custom environment variable "RDS_ENDPOINT"
  shell: |
    rds_endpoint = '$(aws cloudformation describe-stacks --region ap-northeast-1 --stack-name RDSStackFromCircleCI --query "Stacks[].Outputs[].[OutputValue]" --output text)'
    echo 'export RDS_ENDPOINT = "${rds_endpoint}"' >> $BASH_ENV

- name: Import database.yml
  template:
    src: rokes/rails/templates/database.yml.j2
    dest: /var/www/raisetech-live8-sample-app/config/database.yml.j2

